image: mcr.microsoft.com/dotnet/sdk:5.0.301-alpine3.13-amd64

variables:
  BUILD_CONF: 'Release'
  NUGET_FOLDER: './nuget'

stages:
  - build
  - test

cache:
  key: 'nuget'
  paths:
    - '$NUGET_FOLDER'

build:
  stage: build
  script:
    - dotnet restore --packages $NUGET_FOLDER
    - dotnet build --no-restore -c $BUILD_CONF --source $NUGET_FOLDER
  artifacts:
    paths:
      - '**/bin/'
      - '**/obj/'
    expire_in: 30 min

test:
  stage: test
  script:
    # - dotnet clean Indico.Tests/Indico.Tests.csproj -c $BUILD_CONF
    - dotnet test --no-build --no-restore -c $BUILD_CONF --results-directory:'./artifacts/test/' --logger:"junit;LogFileName=./results/{assembly}-test-result.xml" --collect:'XPlat Code Coverage' --filter FullyQualifiedName\!~IntegrationTests -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
    - dotnet tool restore
    - dotnet reportgenerator -reports:./artifacts/test/*/coverage.cobertura.xml -targetdir:./artifacts/test/coverage/ -assemblyFilters:-Indicore -sourcedirs:$PWD -reporttypes:cobertura\;TextSummary
    # fix filename (absolute -> relative path)
    - cat ./artifacts/test/coverage/Cobertura.xml | sed "s/filename=\"$(pwd -P | sed -e 's/\//\\\//g')\//filename=\"/g" > ./artifacts/test/coverage/Cobertura-fixed.xml
    - cat ./artifacts/test/coverage/Summary.txt
  artifacts:
    reports:
      junit: ./artifacts/test/results/*
      cobertura: ./artifacts/test/coverage/Cobertura-fixed.xml
  needs: [ 'build' ]
  dependencies: [ build]
    

# release:
#   stage: release
#   only:
#     - master
#   artifacts:
#     paths:
#       - publish/
#   script:
#     - dotnet publish -c Release -o ../publish ./IndicoV2/IndicoV2.csproj